<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Accessible WebSocket Chat</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #111;
            color: #eee;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        h2 {
            padding: 0.5em;
            margin: 0;
        }

        #log {
            flex: 1;
            overflow-y: auto;
            padding: 1.5em;
            display: flex;
            flex-direction: column;
            gap: 1.2em;
        }

        .chat {
            max-width: 70%;
            padding: 1.2em 1.5em;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.6;
            margin: 0.3em 0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            font-size: 1.05em;
            opacity: 0;
            transform: translateY(8px);
            animation: fadeInUp 0.35s ease forwards;
        }

        .chat .sender {
            font-weight: 700;
            margin-bottom: 0.5em;
            font-size: 0.95em;
        }

        .chat .sender a {
            text-decoration: none;
        }

        .chat .sender a:focus,
        .chat .sender a:hover {
            text-decoration: underline;
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .chat .message {
            font-size: 1.05em;
            white-space: pre-wrap;
        }

        .chat.other {
            background: #2a2a2a;
            align-self: flex-start;
        }

        .chat.self {
            background: #005bbb;
            align-self: flex-end;
            color: #fff;
        }

        .chat.self .sender {
            text-align: right;
        }

        .info {
            align-self: center;
            font-size: 1em;
            font-style: italic;
            color: #eee;
            padding: 0.6em 1em;
            background: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
            opacity: 0;
            transform: translateY(8px);
            animation: fadeInUp 0.35s ease forwards;
        }

        .info a {
            font-weight: bold;
            color: #4da3ff;
            text-decoration: none;
        }

        .info a:hover,
        .info a:focus {
            text-decoration: underline;
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        .input-container {
            border-top: 1px solid #333;
            background: #1a1a1a;
            padding: 1em;
        }

        form {
            display: flex;
            gap: 0.6em;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        input[type="text"] {
            flex: 1;
            padding: 1em 1.2em;
            border-radius: 20px;
            border: none;
            font-family: inherit;
            font-size: 1em;
            min-width: 0;
            background: #2d2d2d;
            color: #eee;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        button {
            padding: 0.8em 1.4em;
            background: #4da3ff;
            border: none;
            border-radius: 20px;
            color: #fff;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        button:hover {
            background: #3993f7;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <h2>💬 Accessible Chat</h2>
    <div id="log"></div>

    <div class="input-container">
        <form id="message-form">
            <input type="text" id="msg" placeholder="Type a message..." autocomplete="off"
                aria-label="Type your message" />
            <button type="submit">Send</button>
        </form>
    </div>

    <script>
        const wsUrl = "ws://localhost:9002/log/topic-a/ws";
        let socket;
        let myId = null;
        let myName = null;

        const userColors = {};
        const SELF_COLOR = "#00e0ff";

        function hashColor(id) {
            if (!id) return "#aaa";
            let hash = 0;
            for (let i = 0; i < id.toString().length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 80%, 50%)`;
        }

        function getUserColor(id, isSelf) {
            if (isSelf) return SELF_COLOR;
            if (!userColors[id]) {
                userColors[id] = hashColor(id.toString());
            }
            return userColors[id];
        }

        function connect() {
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log("✅ Connected to WebSocket");
            };

            socket.onmessage = (event) => {
                try {
                    const obj = JSON.parse(event.data);
                    renderEvent(obj);
                } catch (err) {
                    console.error("Bad JSON:", event.data);
                }
            };

            socket.onclose = () => {
                console.warn("⚠️ WebSocket closed, retrying in 2s");
                setTimeout(connect, 2000);
            };
        }

        function renderEvent(obj) {
            const log = document.getElementById("log");
            const atBottom = log.scrollTop + log.clientHeight >= log.scrollHeight - 5;

            if (obj.evt_name === "identity") {
                myId = obj.data.id;
                myName = obj.data.name;
                const info = document.createElement("div");
                info.className = "info";
                info.textContent = `👋 You are identified as ${myName}`;
                log.appendChild(info);

            } else if (obj.evt_name === "echo" && obj.data) {
                const div = document.createElement("div");
                const isSelf = obj.data.id === myId;
                div.className = "chat " + (isSelf ? "self" : "other");

                const sender = document.createElement("div");
                sender.className = "sender";
                const link = document.createElement("a");
                link.href = `/user/${encodeURIComponent(obj.data.id)}`;
                link.textContent = obj.data.name;
                link.style.color = getUserColor(obj.data.id, isSelf);
                sender.appendChild(link);

                const message = document.createElement("div");
                message.className = "message";
                message.textContent = obj.data.data;

                div.appendChild(sender);
                div.appendChild(message);
                log.appendChild(div);

            } else if (obj.evt_name === "notify-online" && obj.data) {
                const info = document.createElement("div");
                info.className = "info";
                const link = document.createElement("a");
                link.href = `/user/${encodeURIComponent(obj.data.id)}`;
                link.textContent = obj.data.name;
                info.innerHTML = `🔔 ${link.outerHTML} is now online`;
                log.appendChild(info);

            } else {
                const div = document.createElement("div");
                div.className = "info";
                div.textContent = JSON.stringify(obj);
                log.appendChild(div);
            }

            if (atBottom) log.scrollTop = log.scrollHeight;
        }

        function sendMessage(value) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(value);
            }
        }

        document.getElementById("message-form").addEventListener("submit", e => {
            e.preventDefault();
            const msgInput = document.getElementById("msg");
            const value = msgInput.value.trim();
            if (value) {
                sendMessage(value);
                msgInput.value = "";
                msgInput.focus();
            }
        });

        connect();
    </script>
</body>

</html>